const express = require("express")
const bodyParser = require("body-parser")
const {NmapScan} = require("node-nmap")
const { exec } = require('child_process');
const app = express()
const port = 3000
app.use(bodyParser.urlencoded({extended: true}));
app.use(bodyParser.json())
app.get("/", (req,res)=>{
    res.json("HELLo")
})
app.post('/nmap', (req, res) => {
    const { target, options } = req.body;
    const isValidTarget = (input) => {
        const ipv4Pattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        const hostnamePattern = /^[a-zA-Z0-9.-]+$/;
        return ipv4Pattern.test(input) || hostnamePattern.test(input);
      };
    
      if (!target || !isValidTarget(target)) {
        return res.status(400).json({ error: 'A valid target (IP or hostname) is required' });
      }
  
    // Default options if none are provided
    const nmapOptions = options || '-sV';
  
    try {
        var nmapScan = new NmapScan(target, nmapOptions);
  
      nmapScan.on('complete', (data) => {
        res.json(data);
      });
  
      nmapScan.on('error', (error) => {
        console.error('Nmap Error:', error);
        res.status(500).json({ error: 'Nmap execution failed' });
      });
  
      nmapScan.startScan();
    } catch (err) {
      console.error('Error initializing scan:', err);
      res.status(500).json({ error: 'Failed to start scan' });
    }
});

app.post('/sqli', (req, res)=>{
  const { target, script } = req.body;

  if (!target) {
    return res.status(400).send('Target is required');
  }

  // Default script if none provided
  const scriptToRun = script || 'http-sql-injection';
  const command = `nmap --script=${scriptToRun} ${target}`;

  // Execute the Nmap command
  exec(command, (error, stdout, stderr) => {
    if (error) {
      console.error(`exec error: ${error}`);
      return res.status(500).json({ error: error.message });
    }

    if (stderr) {
      console.error(`stderr: ${stderr}`);
      return res.status(500).json({ error: stderr });
    }

    // Send the output as the response
    res.json({ output: stdout });
  });
})

app.listen(port, ()=>{
    console.log("API IS RUNNING ON http://localhost:3000")
})